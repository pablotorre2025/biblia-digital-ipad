<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Biblia Digital - M√∫ltiples Versiones</title>
    <!-- Actualizado: 2025-11-06 - Fix para cambio de versiones -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <h1>üìñ Biblia Digital</h1>
            <div class="header-controls">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Busca desde 3 letras... (ej: jesus)" class="search-input">
                    <button id="searchBtn" class="icon-btn" title="Buscar" onclick="simpleSearch()">üîç</button>
                </div>
                <select id="versionSelector" class="version-selector">
                    <option value="">Seleccionar versi√≥n...</option>
                </select>
                <button id="favoritesBtn" class="icon-btn" title="Favoritos" onclick="showFavorites()">üîñ</button>
                <button id="notesBtn" class="icon-btn" title="Notas" onclick="openNotesViewer()">üìù</button>
                <button id="themesBtn" class="icon-btn" title="Temas" onclick="openThemeSettings()">üé®</button>
                <button id="compareBtn" class="icon-btn" title="Comparar versiones">üîÑ</button>
                <button id="settingsBtn" class="icon-btn" title="Configuraci√≥n">‚öôÔ∏è</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="book-navigation">
        <div class="nav-content">
            <select id="bookSelector" class="book-selector">
                <option value="">Seleccionar libro...</option>
            </select>
            <select id="chapterSelector" class="chapter-selector">
                <option value="">Cap...</option>
            </select>
            <div class="nav-buttons">
                <button id="prevChapter" class="nav-btn" title="Cap√≠tulo anterior">‚óÄ</button>
                <button id="nextChapter" class="nav-btn" title="Cap√≠tulo siguiente">‚ñ∂</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="reading-area">
            <div id="chapterTitle" class="chapter-title"></div>
            <div id="verseContainer" class="verse-container">
                <div class="welcome-message">
                    <h2>Bienvenido a la Biblia Digital</h2>
                    <p>Selecciona una versi√≥n y un libro para comenzar a leer.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner hidden">
        <div class="spinner"></div>
        <p>Cargando...</p>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuraci√≥n</h3>
                <button id="closeSettings" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label for="fontSize">Tama√±o de fuente:</label>
                    <input type="range" id="fontSize" min="14" max="24" value="16">
                    <span id="fontSizeValue">16px</span>
                </div>
                <div class="setting-group">
                    <label for="lineHeight">Altura de l√≠nea:</label>
                    <input type="range" id="lineHeight" min="1.2" max="2.0" step="0.1" value="1.6">
                    <span id="lineHeightValue">1.6</span>
                </div>
                <div class="setting-group">
                    <label for="theme">Tema:</label>
                    <select id="theme">
                        <option value="light">Claro</option>
                        <option value="dark">Oscuro</option>
                        <option value="sepia">Sepia</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="showVerseNumbers"> Mostrar n√∫meros de vers√≠culos
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Versions Modal -->
    <div id="compareModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Comparar Versiones</h3>
                <button id="closeCompare" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="compare-controls">
                    <select id="compareVersion1">
                        <option value="">Selecciona versi√≥n 1</option>
                    </select>
                    <select id="compareVersion2">
                        <option value="">Selecciona versi√≥n 2</option>
                    </select>
                </div>
                <div id="comparisonContent" class="comparison-content">
                    <p>Selecciona dos versiones para comparar</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results Modal -->
    <div id="searchModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Resultados de B√∫squeda</h3>
                <button id="closeSearch" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="search-info">
                    <span id="searchQuery"></span> - <span id="searchCount">0 resultados</span>
                </div>
                <div id="searchResults" class="search-results">
                    <p>Introduce un t√©rmino de b√∫squeda</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favoritesModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Vers√≠culos Favoritos</h3>
                <button id="closeFavorites" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="favorites-controls">
                    <select id="categoryFilter" class="category-filter">
                        <option value="all">Todas las categor√≠as</option>
                        <option value="oraci√≥n">Oraci√≥n</option>
                        <option value="estudio">Estudio</option>
                        <option value="predicaci√≥n">Predicaci√≥n</option>
                        <option value="consuelo">Consuelo</option>
                        <option value="sabidur√≠a">Sabidur√≠a</option>
                    </select>
                    <button id="exportFavorites" class="btn-secondary">üì§ Exportar</button>
                </div>
                <div id="favoritesList" class="favorites-list">
                    <p>No tienes vers√≠culos favoritos a√∫n. ‚ù§Ô∏è Haz clic en el coraz√≥n junto a un vers√≠culo para agregarlo.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuraci√≥n</h3>
                <button id="closeSettings" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <h4>üé® Apariencia</h4>
                    <div class="setting-item">
                        <label for="themeSelect">Tema:</label>
                        <select id="themeSelect" class="theme-select">
                            <option value="light">üåû Claro</option>
                            <option value="dark">üåô Oscuro</option>
                            <option value="sepia">üìú Sepia</option>
                            <option value="blue">üåä Azul</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="fontSizeRange">Tama√±o de fuente:</label>
                        <input type="range" id="fontSizeRange" min="12" max="24" value="16" class="font-range">
                        <span id="fontSizeValue">16px</span>
                    </div>
                </div>
                <div class="setting-group">
                    <h4>üìñ Lectura</h4>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="showVerseNumbers"> Mostrar n√∫meros de vers√≠culos
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="highlightEnabled"> Habilitar resaltado
                        </label>
                    </div>
                </div>
                <div class="setting-group">
                    <h4>üìä Datos</h4>
                    <div class="setting-item">
                        <button id="clearCache" class="btn-secondary">üóëÔ∏è Limpiar cach√©</button>
                        <button id="exportData" class="btn-secondary">üíæ Exportar datos</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="connectionStatus" class="status-offline">üì° Offline</span>
        <span id="lastUpdate"></span>
    </div>

    <script>
        // Funci√≥n para normalizar texto (quitar acentos, convertir a min√∫sculas)
        function normalizeText(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remover acentos
                .replace(/[^a-z0-9\s]/g, ' ')    // Remover caracteres especiales
                .replace(/\s+/g, ' ')            // Normalizar espacios
                .trim();
        }
        
        // Variable para debounce de b√∫squeda en tiempo real
        let searchTimeout;
        
        // Funci√≥n de b√∫squeda mejorada
        function smartSearch(query = null) {
            console.log('=== SMART SEARCH STARTED ===');
            
            const searchInput = document.getElementById('searchInput');
            let searchQuery = query || searchInput.value.trim();
            
            console.log('Original query:', searchQuery);
            
            if (searchQuery.length < 3) {
                closeSimpleSearch();
                return;
            }
            
            // Verificar si hay una app cargada
            if (!window.bibleApp || !window.bibleApp.bibleData) {
                if (searchQuery.length >= 3) {
                    alert('Por favor, selecciona y carga una versi√≥n de la Biblia primero.');
                }
                return;
            }
            
            const bibleData = window.bibleApp.bibleData;
            console.log('Bible data available:', !!bibleData);
            
            // Normalizar la consulta de b√∫squeda
            const normalizedQuery = normalizeText(searchQuery);
            console.log('Normalized query:', normalizedQuery);
            
            const results = [];
            let searchCount = 0;
            const maxResults = 100; // Aumentamos a 100 resultados
            
            // Buscar en todos los libros
            Object.keys(bibleData).forEach(bookName => {
                if (searchCount >= maxResults) return;
                
                Object.keys(bibleData[bookName]).forEach(chapterNum => {
                    if (searchCount >= maxResults) return;
                    
                    Object.keys(bibleData[bookName][chapterNum]).forEach(verseNum => {
                        if (searchCount >= maxResults) return;
                        
                        const originalText = bibleData[bookName][chapterNum][verseNum];
                        const normalizedText = normalizeText(originalText);
                        
                        // Buscar tanto con query original como normalizada
                        if (normalizedText.includes(normalizedQuery) || 
                            originalText.toLowerCase().includes(searchQuery.toLowerCase())) {
                            
                            results.push({
                                book: bookName,
                                chapter: chapterNum,
                                verse: verseNum,
                                text: originalText,
                                reference: `${bookName} ${chapterNum}:${verseNum}`,
                                normalizedText: normalizedText
                            });
                            searchCount++;
                        }
                    });
                });
            });
            
            console.log('Results found:', results.length);
            
            // Mostrar resultados inmediatamente
            showSmartSearchResults(searchQuery, normalizedQuery, results);
        }
        
        // Funci√≥n de b√∫squeda en tiempo real con debounce
        function realTimeSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                smartSearch();
            }, 300); // Esperar 300ms despu√©s de dejar de escribir
        }
        
        function showSmartSearchResults(originalQuery, normalizedQuery, results) {
            console.log('Showing smart search results...');
            
            // Crear modal din√°micamente si no existe
            let modal = document.getElementById('simpleSearchModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'simpleSearchModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                document.body.appendChild(modal);
            }
            
            if (results.length === 0) {
                modal.innerHTML = `
                    <div style="background: white; border-radius: 8px; max-width: 80%; max-height: 80%; overflow-y: auto; position: relative; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>No se encontraron resultados para "${originalQuery}"</h3>
                            <button onclick="closeSimpleSearch()" style="background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
                        </div>
                        <p style="color: #666;">Intenta con otras palabras o verifica la ortograf√≠a.</p>
                        <p style="color: #888; font-size: 14px;">üí° Tip: La b√∫squeda funciona sin acentos (Jesus = Jes√∫s)</p>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }
            
            // Crear expresiones regulares para resaltar tanto query original como normalizada
            const highlightRegex1 = new RegExp(`(${escapeRegExp(originalQuery)})`, 'gi');
            const highlightRegex2 = new RegExp(`(${escapeRegExp(normalizedQuery)})`, 'gi');
            
            const resultsHtml = results.map((result, index) => {
                let highlightedText = result.text;
                
                // Resaltar coincidencias (primero query original, luego normalizada)
                highlightedText = highlightedText.replace(highlightRegex1, '<mark style="background: #ffeb3b; padding: 1px 3px; border-radius: 2px; font-weight: bold;">$1</mark>');
                
                // Si no hay coincidencias con query original, intentar con normalizada
                if (!highlightedText.includes('<mark')) {
                    // Buscar palabras que coincidan despu√©s de normalizar
                    const words = result.text.split(/\s+/);
                    words.forEach(word => {
                        const normalizedWord = normalizeText(word);
                        if (normalizedWord.includes(normalizedQuery)) {
                            const wordRegex = new RegExp(`\\b${escapeRegExp(word)}\\b`, 'gi');
                            highlightedText = highlightedText.replace(wordRegex, '<mark style="background: #81c784; padding: 1px 3px; border-radius: 2px; font-weight: bold;">$&</mark>');
                        }
                    });
                }
                
                return `
                    <div style="padding: 16px; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background 0.2s;" 
                         onclick="goToVerse('${result.book}', ${result.chapter}, ${result.verse})"
                         onmouseover="this.style.background='#f5f5f5'" 
                         onmouseout="this.style.background='white'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #1976d2; font-size: 16px;">${result.reference}</strong>
                            <span style="color: #666; font-size: 12px;">#${index + 1}</span>
                        </div>
                        <div style="line-height: 1.6; color: #333;">${highlightedText}</div>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 85%; max-height: 85%; overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px; border-bottom: 2px solid #e0e0e0; background: linear-gradient(135deg, #1976d2, #42a5f5); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 20px;">üîç Resultados de b√∫squeda</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9;">"${originalQuery}" - ${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}</p>
                            </div>
                            <button onclick="closeSimpleSearch()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 18px; width: 40px; height: 40px;">‚úï</button>
                        </div>
                    </div>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        ${resultsHtml}
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #e0e0e0; text-align: center; color: #666; font-size: 14px;">
                        üí° Haz clic en cualquier resultado para ir al vers√≠culo
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // Funci√≥n para escapar caracteres especiales en regex
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Funci√≥n simple de b√∫squeda (mantener compatibilidad)
        function simpleSearch() {
            smartSearch();
        }
        
        function closeSimpleSearch() {
            const modal = document.getElementById('simpleSearchModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function goToVerse(book, chapter, verse) {
            console.log(`Navigating to ${book} ${chapter}:${verse}`);
            closeSimpleSearch();
            
            if (window.bibleApp) {
                // Navegar al vers√≠culo
                window.bibleApp.selectBook(book).then(() => {
                    setTimeout(() => {
                        window.bibleApp.loadChapter(book, parseInt(chapter)).then(() => {
                            setTimeout(() => {
                                const verseElement = document.querySelector(`[data-verse="${verse}"]`);
                                if (verseElement) {
                                    verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    verseElement.style.background = 'linear-gradient(135deg, #4285f4, #34a853)';
                                    verseElement.style.color = 'white';
                                    verseElement.style.padding = '12px';
                                    verseElement.style.borderRadius = '8px';
                                    verseElement.style.transform = 'scale(1.02)';
                                    verseElement.style.transition = 'all 0.3s ease';
                                    verseElement.style.boxShadow = '0 4px 15px rgba(66, 133, 244, 0.3)';
                                    
                                    setTimeout(() => {
                                        verseElement.style.background = '';
                                        verseElement.style.color = '';
                                        verseElement.style.padding = '';
                                        verseElement.style.transform = '';
                                        verseElement.style.boxShadow = '';
                                    }, 4000);
                                }
                            }, 500);
                        });
                    }, 200);
                });
            }
        }
        
        // Configurar b√∫squeda en tiempo real
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // B√∫squeda en tiempo real mientras escribes
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.trim();
                    if (query.length >= 3) {
                        realTimeSearch();
                    } else if (query.length === 0) {
                        closeSimpleSearch();
                    }
                });
                
                // Tambi√©n permitir b√∫squeda con Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        smartSearch();
                    }
                });
                
                // Mostrar tip cuando hace focus
                searchInput.addEventListener('focus', function() {
                    if (!this.value) {
                        this.placeholder = 'Escribe al menos 3 letras (ej: jesus, Jes√∫s, JES√öS...)';
                    }
                });
                
                searchInput.addEventListener('blur', function() {
                    this.placeholder = 'Buscar en la Biblia...';
                });
            }
        });
        
        // === SISTEMA DE FAVORITOS COMPLETO ===
        
        // Clase para manejar favoritos
        class FavoritesManager {
            constructor() {
                this.storageKey = 'bible-favorites';
                this.favorites = this.loadFavorites();
            }
            
            loadFavorites() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Error loading favorites:', error);
                    return [];
                }
            }
            
            saveFavorites() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.favorites));
                    return true;
                } catch (error) {
                    console.error('Error saving favorites:', error);
                    return false;
                }
            }
            
            addFavorite(book, chapter, verse, text, version) {
                const favorite = {
                    id: `${book}-${chapter}-${verse}-${version}`,
                    book,
                    chapter: parseInt(chapter),
                    verse: parseInt(verse),
                    text: text.substring(0, 200), // Limitar texto
                    version,
                    dateAdded: new Date().toISOString(),
                    reference: `${book} ${chapter}:${verse}`
                };
                
                // Verificar si ya existe
                const exists = this.favorites.find(f => f.id === favorite.id);
                if (exists) {
                    return { success: false, message: 'Este vers√≠culo ya est√° en favoritos' };
                }
                
                this.favorites.unshift(favorite); // Agregar al inicio
                const saved = this.saveFavorites();
                
                if (saved) {
                    return { success: true, message: 'Vers√≠culo agregado a favoritos ‚≠ê' };
                } else {
                    return { success: false, message: 'Error al guardar favorito' };
                }
            }
            
            removeFavorite(id) {
                const index = this.favorites.findIndex(f => f.id === id);
                if (index !== -1) {
                    this.favorites.splice(index, 1);
                    this.saveFavorites();
                    return true;
                }
                return false;
            }
            
            isFavorite(book, chapter, verse, version) {
                const id = `${book}-${chapter}-${verse}-${version}`;
                return this.favorites.some(f => f.id === id);
            }
            
            getFavorites() {
                return [...this.favorites]; // Retornar copia
            }
            
            searchFavorites(query) {
                const normalizedQuery = normalizeText(query);
                return this.favorites.filter(fav => {
                    const normalizedText = normalizeText(fav.text);
                    const normalizedRef = normalizeText(fav.reference);
                    return normalizedText.includes(normalizedQuery) || 
                           normalizedRef.includes(normalizedQuery);
                });
            }
            
            exportFavorites() {
                const exportData = {
                    exportDate: new Date().toISOString(),
                    totalFavorites: this.favorites.length,
                    favorites: this.favorites
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `biblia-favoritos-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }
            
            getStats() {
                const bookStats = {};
                const versionStats = {};
                
                this.favorites.forEach(fav => {
                    bookStats[fav.book] = (bookStats[fav.book] || 0) + 1;
                    versionStats[fav.version] = (versionStats[fav.version] || 0) + 1;
                });
                
                return {
                    total: this.favorites.length,
                    books: bookStats,
                    versions: versionStats,
                    oldestDate: this.favorites.length > 0 ? 
                        Math.min(...this.favorites.map(f => new Date(f.dateAdded).getTime())) : null,
                    newestDate: this.favorites.length > 0 ? 
                        Math.max(...this.favorites.map(f => new Date(f.dateAdded).getTime())) : null
                };
            }
        }
        
        // Inicializar manager de favoritos
        const favoritesManager = new FavoritesManager();
        
        // Funci√≥n para agregar vers√≠culo actual a favoritos
        function addCurrentVerseToFavorites(book, chapter, verse) {
            if (!window.bibleApp || !window.bibleApp.bibleData) {
                showToast('‚ùå Selecciona una versi√≥n b√≠blica primero', 'error');
                return;
            }
            
            const bibleData = window.bibleApp.bibleData;
            const currentVersion = window.bibleApp.currentVersion;
            
            if (!bibleData[book] || !bibleData[book][chapter] || !bibleData[book][chapter][verse]) {
                showToast('‚ùå Vers√≠culo no encontrado', 'error');
                return;
            }
            
            const text = bibleData[book][chapter][verse];
            const result = favoritesManager.addFavorite(book, chapter, verse, text, currentVersion);
            
            if (result.success) {
                showToast(result.message, 'success');
                updateFavoriteButtons();
            } else {
                showToast(result.message, 'warning');
            }
        }
        
        // Funci√≥n para abrir favoritos
        function openFavorites() {
            const favorites = favoritesManager.getFavorites();
            showFavoritesModal(favorites);
        }
        
        // Funci√≥n para mostrar modal de favoritos
        function showFavoritesModal(favorites) {
            let modal = document.getElementById('favoritesModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'favoritesModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    z-index: 1001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                document.body.appendChild(modal);
            }
            
            if (favorites.length === 0) {
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 85%; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
                        <div style="padding: 25px; text-align: center; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white;">
                            <h2 style="margin: 0; font-size: 24px;">‚≠ê Mis Favoritos</h2>
                            <p style="margin: 8px 0 0 0; opacity: 0.9;">Tu colecci√≥n personal de vers√≠culos</p>
                        </div>
                        <div style="padding: 40px; text-align: center;">
                            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üìñ</div>
                            <h3 style="color: #666; margin-bottom: 15px;">No tienes favoritos a√∫n</h3>
                            <p style="color: #888; margin-bottom: 25px; line-height: 1.6;">
                                üí° Para agregar vers√≠culos a favoritos:<br>
                                1. Navega a cualquier vers√≠culo<br>
                                2. Haz clic en el ‚≠ê que aparece junto al n√∫mero del vers√≠culo<br>
                                3. ¬°Tu vers√≠culo se guardar√° aqu√≠!
                            </p>
                            <button onclick="closeFavorites()" style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                Entendido
                            </button>
                        </div>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }
            
            const stats = favoritesManager.getStats();
            const favoritesHtml = favorites.map((fav, index) => `
                <div style="padding: 16px; border-bottom: 1px solid #e0e0e0; position: relative; transition: all 0.3s ease;" 
                     onmouseover="this.style.background='#f8f9fa'" 
                     onmouseout="this.style.background='white'">
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="background: linear-gradient(135deg, #4285f4, #34a853); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                    ${fav.version}
                                </span>
                                <strong style="color: #1976d2; font-size: 16px; cursor: pointer;" 
                                        onclick="goToFavoriteVerse('${fav.book}', ${fav.chapter}, ${fav.verse})"
                                        onmouseover="this.style.textDecoration='underline'"
                                        onmouseout="this.style.textDecoration='none'">
                                    ${fav.reference}
                                </strong>
                            </div>
                            <div style="color: #666; font-size: 12px; margin-bottom: 8px;">
                                üìÖ Agregado: ${new Date(fav.dateAdded).toLocaleDateString('es-ES', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                        </div>
                        
                        <button onclick="removeFavoriteVerse('${fav.id}')" 
                                style="background: #ff4444; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; min-width: 60px;"
                                onmouseover="this.style.background='#cc0000'"
                                onmouseout="this.style.background='#ff4444'">
                            üóëÔ∏è Quitar
                        </button>
                    </div>
                    
                    <div style="line-height: 1.6; color: #333; font-style: italic; padding: 8px 0;">
                        "${fav.text}${fav.text.length >= 200 ? '...' : ''}"
                    </div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 85%; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0; font-size: 22px;">‚≠ê Mis Favoritos</h2>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    ${stats.total} vers√≠culo${stats.total !== 1 ? 's' : ''} guardado${stats.total !== 1 ? 's' : ''} ‚Ä¢ ${Object.keys(stats.books).length} libro${Object.keys(stats.books).length !== 1 ? 's' : ''}
                                </p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="searchInFavorites()" 
                                        style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    üîç Buscar
                                </button>
                                <button onclick="exportFavorites()" 
                                        style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    üì§ Exportar
                                </button>
                                <button onclick="closeFavorites()" 
                                        style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 18px; width: 36px; height: 36px;">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="max-height: 65vh; overflow-y: auto;">
                        ${favoritesHtml}
                    </div>
                    
                    <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #e0e0e0; text-align: center;">
                        <div style="color: #666; font-size: 13px; margin-bottom: 5px;">
                            üí° Haz clic en cualquier referencia para ir al vers√≠culo
                        </div>
                        <div style="color: #888; font-size: 12px;">
                            Los favoritos se guardan autom√°ticamente en tu dispositivo
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // Funciones auxiliares para favoritos
        function closeFavorites() {
            const modal = document.getElementById('favoritesModal');
            if (modal) modal.style.display = 'none';
        }
        
        function goToFavoriteVerse(book, chapter, verse) {
            closeFavorites();
            if (window.bibleApp) {
                window.bibleApp.selectBook(book).then(() => {
                    setTimeout(() => {
                        window.bibleApp.loadChapter(book, parseInt(chapter)).then(() => {
                            setTimeout(() => {
                                const verseElement = document.querySelector(`[data-verse="${verse}"]`);
                                if (verseElement) {
                                    verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    highlightVerse(verseElement, 'favorite');
                                }
                            }, 500);
                        });
                    }, 200);
                });
            }
        }
        
        function removeFavoriteVerse(id) {
            if (confirm('¬øEst√°s seguro de que quieres quitar este vers√≠culo de favoritos?')) {
                if (favoritesManager.removeFavorite(id)) {
                    showToast('üóëÔ∏è Vers√≠culo quitado de favoritos', 'info');
                    openFavorites(); // Refrescar modal
                    updateFavoriteButtons();
                } else {
                    showToast('‚ùå Error al quitar favorito', 'error');
                }
            }
        }
        
        function exportFavorites() {
            favoritesManager.exportFavorites();
            showToast('üì§ Favoritos exportados exitosamente', 'success');
        }
        
        function searchInFavorites() {
            const query = prompt('üîç Buscar en favoritos:\n\n(Puedes buscar por texto del vers√≠culo o referencia)');
            if (query && query.trim()) {
                const results = favoritesManager.searchFavorites(query.trim());
                showFavoritesModal(results);
            }
        }
        
        // Funci√≥n para destacar vers√≠culos
        function highlightVerse(element, type = 'search') {
            const colors = {
                search: { bg: 'linear-gradient(135deg, #4285f4, #34a853)', shadow: 'rgba(66, 133, 244, 0.3)' },
                favorite: { bg: 'linear-gradient(135deg, #ff6b35, #f7931e)', shadow: 'rgba(255, 107, 53, 0.3)' }
            };
            
            const color = colors[type];
            element.style.background = color.bg;
            element.style.color = 'white';
            element.style.padding = '12px';
            element.style.borderRadius = '8px';
            element.style.transform = 'scale(1.02)';
            element.style.transition = 'all 0.3s ease';
            element.style.boxShadow = `0 4px 15px ${color.shadow}`;
            
            setTimeout(() => {
                element.style.background = '';
                element.style.color = '';
                element.style.padding = '';
                element.style.transform = '';
                element.style.boxShadow = '';
            }, 4000);
        }
        
        // Sistema de notificaciones toast
        function showToast(message, type = 'info') {
            const colors = {
                success: { bg: '#4caf50', icon: '‚úÖ' },
                error: { bg: '#f44336', icon: '‚ùå' },
                warning: { bg: '#ff9800', icon: '‚ö†Ô∏è' },
                info: { bg: '#2196f3', icon: '‚ÑπÔ∏è' }
            };
            
            const color = colors[type] || colors.info;
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color.bg};
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 350px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            toast.innerHTML = `${color.icon} ${message}`;
            document.body.appendChild(toast);
            
            // Animar entrada
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Quitar despu√©s de 3 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // Funci√≥n para actualizar botones de favoritos en vers√≠culos
        function updateFavoriteButtons() {
            // Esta funci√≥n se llamar√° cuando se cargue un cap√≠tulo para mostrar los botones ‚≠ê
            const verses = document.querySelectorAll('[data-verse]');
            verses.forEach(verseElement => {
                const verse = verseElement.getAttribute('data-verse');
                if (window.bibleApp && window.bibleApp.currentBook && window.bibleApp.currentChapter) {
                    addFavoriteButtonToVerse(verseElement, window.bibleApp.currentBook, window.bibleApp.currentChapter, verse);
                }
            });
        }
        
        function addFavoriteButtonToVerse(verseElement, book, chapter, verse) {
            // Evitar duplicar botones
            if (verseElement.querySelector('.favorite-btn')) return;
            
            const isFav = favoritesManager.isFavorite(book, chapter, verse, window.bibleApp?.currentVersion);
            
            const favButton = document.createElement('button');
            favButton.className = 'favorite-btn';
            favButton.innerHTML = isFav ? '‚≠ê' : '‚òÜ';
            favButton.style.cssText = `
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                padding: 4px;
                margin-left: 8px;
                opacity: 0.7;
                transition: all 0.2s ease;
            `;
            
            favButton.onclick = (e) => {
                e.stopPropagation();
                if (isFav) {
                    const id = `${book}-${chapter}-${verse}-${window.bibleApp.currentVersion}`;
                    if (favoritesManager.removeFavorite(id)) {
                        favButton.innerHTML = '‚òÜ';
                        showToast('üóëÔ∏è Quitado de favoritos', 'info');
                    }
                } else {
                    addCurrentVerseToFavorites(book, chapter, verse);
                    favButton.innerHTML = '‚≠ê';
                }
            };
            
            favButton.onmouseover = () => {
                favButton.style.opacity = '1';
                favButton.style.transform = 'scale(1.2)';
            };
            
            favButton.onmouseout = () => {
                favButton.style.opacity = '0.7';
                favButton.style.transform = 'scale(1)';
            };
            
            // Insertar el bot√≥n despu√©s del n√∫mero de vers√≠culo
            const verseNumber = verseElement.querySelector('.verse-number, strong');
            if (verseNumber) {
                verseNumber.appendChild(favButton);
            } else {
                verseElement.insertBefore(favButton, verseElement.firstChild);
            }
        }
        
        // === SISTEMA DE NOTAS PERSONALES ===
        
        class NotesManager {
            constructor() {
                this.storageKey = 'bible-notes';
                this.notes = this.loadNotes();
                this.colors = [
                    { name: 'Amarillo', value: '#fff3cd', border: '#ffc107' },
                    { name: 'Verde', value: '#d4edda', border: '#28a745' },
                    { name: 'Azul', value: '#d1ecf1', border: '#17a2b8' },
                    { name: 'Naranja', value: '#ffe8d1', border: '#fd7e14' },
                    { name: 'Rosa', value: '#f8d7da', border: '#dc3545' },
                    { name: 'Morado', value: '#e2d9f3', border: '#6f42c1' }
                ];
            }
            
            loadNotes() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : {};
                } catch (error) {
                    console.error('Error loading notes:', error);
                    return {};
                }
            }
            
            saveNotes() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.notes));
                    return true;
                } catch (error) {
                    console.error('Error saving notes:', error);
                    return false;
                }
            }
            
            addNote(book, chapter, verse, version, note, color = 0) {
                const noteId = `${book}-${chapter}-${verse}-${version}`;
                this.notes[noteId] = {
                    id: noteId,
                    book,
                    chapter: parseInt(chapter),
                    verse: parseInt(verse),
                    version,
                    note: note.trim(),
                    color: this.colors[color],
                    colorIndex: color,
                    dateCreated: new Date().toISOString(),
                    dateModified: new Date().toISOString(),
                    reference: `${book} ${chapter}:${verse}`
                };
                
                this.saveNotes();
                return this.notes[noteId];
            }
            
            updateNote(noteId, newNote, newColor = null) {
                if (this.notes[noteId]) {
                    this.notes[noteId].note = newNote.trim();
                    this.notes[noteId].dateModified = new Date().toISOString();
                    
                    if (newColor !== null) {
                        this.notes[noteId].color = this.colors[newColor];
                        this.notes[noteId].colorIndex = newColor;
                    }
                    
                    this.saveNotes();
                    return this.notes[noteId];
                }
                return null;
            }
            
            removeNote(noteId) {
                if (this.notes[noteId]) {
                    delete this.notes[noteId];
                    this.saveNotes();
                    return true;
                }
                return false;
            }
            
            getNote(book, chapter, verse, version) {
                const noteId = `${book}-${chapter}-${verse}-${version}`;
                return this.notes[noteId] || null;
            }
            
            hasNote(book, chapter, verse, version) {
                const noteId = `${book}-${chapter}-${verse}-${version}`;
                return !!this.notes[noteId];
            }
            
            getAllNotes() {
                return Object.values(this.notes);
            }
            
            searchNotes(query) {
                const normalizedQuery = normalizeText(query);
                return Object.values(this.notes).filter(note => {
                    const normalizedNote = normalizeText(note.note);
                    const normalizedRef = normalizeText(note.reference);
                    return normalizedNote.includes(normalizedQuery) || 
                           normalizedRef.includes(normalizedQuery);
                });
            }
            
            exportNotes() {
                const exportData = {
                    exportDate: new Date().toISOString(),
                    totalNotes: Object.keys(this.notes).length,
                    notes: this.notes
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `biblia-notas-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }
            
            getStats() {
                const notes = Object.values(this.notes);
                const bookStats = {};
                const colorStats = {};
                
                notes.forEach(note => {
                    bookStats[note.book] = (bookStats[note.book] || 0) + 1;
                    colorStats[note.color.name] = (colorStats[note.color.name] || 0) + 1;
                });
                
                return {
                    total: notes.length,
                    books: bookStats,
                    colors: colorStats,
                    averageLength: notes.length > 0 ? Math.round(notes.reduce((sum, note) => sum + note.note.length, 0) / notes.length) : 0
                };
            }
        }
        
        // Inicializar manager de notas
        const notesManager = new NotesManager();
        
        // Funci√≥n para agregar/editar nota
        function addNoteToVerse(book, chapter, verse) {
            if (!window.bibleApp || !window.bibleApp.currentVersion) {
                showToast('‚ùå Selecciona una versi√≥n b√≠blica primero', 'error');
                return;
            }
            
            const version = window.bibleApp.currentVersion;
            const existingNote = notesManager.getNote(book, chapter, verse, version);
            
            showNoteModal(book, chapter, verse, version, existingNote);
        }
        
        // Modal para crear/editar notas
        function showNoteModal(book, chapter, verse, version, existingNote = null) {
            let modal = document.getElementById('noteModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'noteModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    z-index: 1002;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                document.body.appendChild(modal);
            }
            
            const reference = `${book} ${chapter}:${verse}`;
            const isEditing = !!existingNote;
            const currentNote = existingNote ? existingNote.note : '';
            const currentColor = existingNote ? existingNote.colorIndex : 0;
            
            // Generar selector de colores
            const colorOptions = notesManager.colors.map((color, index) => `
                <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;" 
                       onmouseover="this.style.background='#f5f5f5'" 
                       onmouseout="this.style.background='transparent'">
                    <input type="radio" name="noteColor" value="${index}" ${index === currentColor ? 'checked' : ''} 
                           style="margin: 0;">
                    <div style="width: 20px; height: 20px; background: ${color.value}; border: 2px solid ${color.border}; border-radius: 4px;"></div>
                    <span style="font-size: 14px; color: #333;">${color.name}</span>
                </label>
            `).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 85%; min-width: 400px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white;">
                        <h2 style="margin: 0; font-size: 22px;">üìù ${isEditing ? 'Editar' : 'Agregar'} Nota</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 16px;">${reference} - ${version}</p>
                    </div>
                    
                    <div style="padding: 25px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">Nota personal:</label>
                            <textarea id="noteText" 
                                    placeholder="Escribe tu reflexi√≥n, comentario o recordatorio sobre este vers√≠culo..."
                                    style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical; outline: none; transition: border-color 0.3s;"
                                    onfocus="this.style.borderColor='#6c5ce7'"
                                    onblur="this.style.borderColor='#e0e0e0'">${currentNote}</textarea>
                            <div style="text-align: right; margin-top: 4px; color: #888; font-size: 12px;">
                                <span id="charCounter">0</span> caracteres
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 12px; color: #333;">Color de resaltado:</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px;">
                                ${colorOptions}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeNoteModal()" 
                                    style="background: #95a5a6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.3s;"
                                    onmouseover="this.style.background='#7f8c8d'"
                                    onmouseout="this.style.background='#95a5a6'">
                                Cancelar
                            </button>
                            
                            ${isEditing ? `
                                <button onclick="deleteCurrentNote('${book}', ${chapter}, ${verse}, '${version}')"
                                        style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.3s;"
                                        onmouseover="this.style.background='#c0392b'"
                                        onmouseout="this.style.background='#e74c3c'">
                                    üóëÔ∏è Eliminar
                                </button>
                            ` : ''}
                            
                            <button onclick="saveNoteFromModal('${book}', ${chapter}, ${verse}, '${version}', ${isEditing})"
                                    style="background: #6c5ce7; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.3s;"
                                    onmouseover="this.style.background='#5f3dc4'"
                                    onmouseout="this.style.background='#6c5ce7'">
                                üíæ ${isEditing ? 'Actualizar' : 'Guardar'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Configurar contador de caracteres
            const textarea = document.getElementById('noteText');
            const counter = document.getElementById('charCounter');
            
            function updateCounter() {
                counter.textContent = textarea.value.length;
            }
            
            textarea.addEventListener('input', updateCounter);
            updateCounter();
            
            // Focus en textarea
            setTimeout(() => textarea.focus(), 100);
        }
        
        function closeNoteModal() {
            const modal = document.getElementById('noteModal');
            if (modal) modal.style.display = 'none';
        }
        
        function saveNoteFromModal(book, chapter, verse, version, isEditing) {
            const noteText = document.getElementById('noteText').value.trim();
            const selectedColor = document.querySelector('input[name="noteColor"]:checked').value;
            
            if (!noteText) {
                showToast('‚ö†Ô∏è La nota no puede estar vac√≠a', 'warning');
                return;
            }
            
            if (isEditing) {
                const noteId = `${book}-${chapter}-${verse}-${version}`;
                notesManager.updateNote(noteId, noteText, parseInt(selectedColor));
                showToast('‚úÖ Nota actualizada correctamente', 'success');
            } else {
                notesManager.addNote(book, chapter, verse, version, noteText, parseInt(selectedColor));
                showToast('‚úÖ Nota agregada correctamente', 'success');
            }
            
            closeNoteModal();
            updateVerseHighlights();
            updateNoteButtons();
        }
        
        function deleteCurrentNote(book, chapter, verse, version) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta nota?')) {
                const noteId = `${book}-${chapter}-${verse}-${version}`;
                if (notesManager.removeNote(noteId)) {
                    showToast('üóëÔ∏è Nota eliminada', 'info');
                    closeNoteModal();
                    updateVerseHighlights();
                    updateNoteButtons();
                }
            }
        }
        
        // Funci√≥n para mostrar todas las notas
        function openNotesViewer() {
            const notes = notesManager.getAllNotes();
            showNotesModal(notes);
        }
        
        function showNotesModal(notes) {
            let modal = document.getElementById('notesModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'notesModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    z-index: 1001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                document.body.appendChild(modal);
            }
            
            if (notes.length === 0) {
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 85%; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
                        <div style="padding: 25px; text-align: center; background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white;">
                            <h2 style="margin: 0; font-size: 24px;">üìù Mis Notas</h2>
                            <p style="margin: 8px 0 0 0; opacity: 0.9;">Tus reflexiones y comentarios</p>
                        </div>
                        <div style="padding: 40px; text-align: center;">
                            <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üìù</div>
                            <h3 style="color: #666; margin-bottom: 15px;">No tienes notas a√∫n</h3>
                            <p style="color: #888; margin-bottom: 25px; line-height: 1.6;">
                                üí° Para agregar notas a vers√≠culos:<br>
                                1. Navega a cualquier vers√≠culo<br>
                                2. Haz clic en el üìù que aparece junto al n√∫mero<br>
                                3. Escribe tu reflexi√≥n personal<br>
                                4. ¬°Tu nota se guardar√° con colores!
                            </p>
                            <button onclick="closeNotesModal()" style="background: #6c5ce7; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                Entendido
                            </button>
                        </div>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }
            
            const stats = notesManager.getStats();
            const notesHtml = notes.map((note, index) => `
                <div style="margin-bottom: 20px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 5px solid ${note.color.border};">
                    
                    <div style="background: ${note.color.value}; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #333; font-size: 16px; cursor: pointer;" 
                                    onclick="goToNoteVerse('${note.book}', ${note.chapter}, ${note.verse})"
                                    onmouseover="this.style.textDecoration='underline'"
                                    onmouseout="this.style.textDecoration='none'">
                                ${note.reference}
                            </strong>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editNote('${note.book}', ${note.chapter}, ${note.verse}, '${note.version}')"
                                        style="background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteNote('${note.id}')"
                                        style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.7); padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                            <span style="background: linear-gradient(135deg, #333, #555); color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px; font-weight: bold;">
                                ${note.version}
                            </span>
                        </div>
                        
                        <div style="color: #333; font-size: 12px; opacity: 0.8;">
                            üìÖ Creada: ${new Date(note.dateCreated).toLocaleDateString('es-ES', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                            ${note.dateModified !== note.dateCreated ? ` ‚Ä¢ Editada: ${new Date(note.dateModified).toLocaleDateString('es-ES', { 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}` : ''}
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px;">
                        <div style="line-height: 1.6; color: #333; font-style: italic;">
                            "${note.note}"
                        </div>
                    </div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 85%; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0; font-size: 22px;">üìù Mis Notas</h2>
                                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                    ${stats.total} nota${stats.total !== 1 ? 's' : ''} ‚Ä¢ ${Object.keys(stats.books).length} libro${Object.keys(stats.books).length !== 1 ? 's' : ''} ‚Ä¢ Promedio: ${stats.averageLength} caracteres
                                </p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="searchInNotes()" 
                                        style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    üîç Buscar
                                </button>
                                <button onclick="exportNotes()" 
                                        style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    üì§ Exportar
                                </button>
                                <button onclick="closeNotesModal()" 
                                        style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 18px; width: 36px; height: 36px;">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="max-height: 65vh; overflow-y: auto; padding: 20px;">
                        ${notesHtml}
                    </div>
                    
                    <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #e0e0e0; text-align: center;">
                        <div style="color: #666; font-size: 13px; margin-bottom: 5px;">
                            üí° Haz clic en cualquier referencia para ir al vers√≠culo
                        </div>
                        <div style="color: #888; font-size: 12px;">
                            Las notas se guardan autom√°ticamente con colores personalizables
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function closeNotesModal() {
            const modal = document.getElementById('notesModal');
            if (modal) modal.style.display = 'none';
        }
        
        function goToNoteVerse(book, chapter, verse) {
            closeNotesModal();
            if (window.bibleApp) {
                window.bibleApp.selectBook(book).then(() => {
                    setTimeout(() => {
                        window.bibleApp.loadChapter(book, parseInt(chapter)).then(() => {
                            setTimeout(() => {
                                const verseElement = document.querySelector(`[data-verse="${verse}"]`);
                                if (verseElement) {
                                    verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    highlightVerse(verseElement, 'note');
                                }
                            }, 500);
                        });
                    }, 200);
                });
            }
        }
        
        function editNote(book, chapter, verse, version) {
            closeNotesModal();
            setTimeout(() => {
                addNoteToVerse(book, chapter, verse);
            }, 300);
        }
        
        function deleteNote(noteId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta nota?')) {
                if (notesManager.removeNote(noteId)) {
                    showToast('üóëÔ∏è Nota eliminada', 'info');
                    openNotesViewer(); // Refrescar modal
                    updateVerseHighlights();
                    updateNoteButtons();
                }
            }
        }
        
        function exportNotes() {
            notesManager.exportNotes();
            showToast('üì§ Notas exportadas exitosamente', 'success');
        }
        
        function searchInNotes() {
            const query = prompt('üîç Buscar en notas:\n\n(Puedes buscar por contenido de la nota o referencia)');
            if (query && query.trim()) {
                const results = notesManager.searchNotes(query.trim());
                showNotesModal(results);
            }
        }
        
        // Funciones para actualizar interfaz
        function updateNoteButtons() {
            const verses = document.querySelectorAll('[data-verse]');
            verses.forEach(verseElement => {
                const verse = verseElement.getAttribute('data-verse');
                if (window.bibleApp && window.bibleApp.currentBook && window.bibleApp.currentChapter) {
                    addNoteButtonToVerse(verseElement, window.bibleApp.currentBook, window.bibleApp.currentChapter, verse);
                }
            });
        }
        
        function addNoteButtonToVerse(verseElement, book, chapter, verse) {
            // Evitar duplicar botones
            if (verseElement.querySelector('.note-btn')) return;
            
            const hasNote = notesManager.hasNote(book, chapter, verse, window.bibleApp?.currentVersion);
            
            const noteButton = document.createElement('button');
            noteButton.className = 'note-btn';
            noteButton.innerHTML = hasNote ? 'üìù' : 'üìÑ';
            noteButton.style.cssText = `
                background: none;
                border: none;
                font-size: 16px;
                cursor: pointer;
                padding: 4px;
                margin-left: 6px;
                opacity: 0.7;
                transition: all 0.2s ease;
            `;
            
            if (hasNote) {
                noteButton.title = 'Editar nota';
            } else {
                noteButton.title = 'Agregar nota';
            }
            
            noteButton.onclick = (e) => {
                e.stopPropagation();
                addNoteToVerse(book, chapter, verse);
            };
            
            noteButton.onmouseover = () => {
                noteButton.style.opacity = '1';
                noteButton.style.transform = 'scale(1.2)';
            };
            
            noteButton.onmouseout = () => {
                noteButton.style.opacity = '0.7';
                noteButton.style.transform = 'scale(1)';
            };
            
            // Insertar el bot√≥n despu√©s del bot√≥n de favoritos
            const favButton = verseElement.querySelector('.favorite-btn');
            if (favButton) {
                favButton.parentNode.insertBefore(noteButton, favButton.nextSibling);
            } else {
                const verseNumber = verseElement.querySelector('.verse-number, strong');
                if (verseNumber) {
                    verseNumber.appendChild(noteButton);
                } else {
                    verseElement.insertBefore(noteButton, verseElement.firstChild);
                }
            }
        }
        
        function updateVerseHighlights() {
            if (!window.bibleApp || !window.bibleApp.currentBook || !window.bibleApp.currentChapter) return;
            
            const verses = document.querySelectorAll('[data-verse]');
            verses.forEach(verseElement => {
                const verse = verseElement.getAttribute('data-verse');
                const note = notesManager.getNote(
                    window.bibleApp.currentBook, 
                    window.bibleApp.currentChapter, 
                    verse, 
                    window.bibleApp.currentVersion
                );
                
                if (note) {
                    verseElement.style.background = note.color.value;
                    verseElement.style.borderLeft = `4px solid ${note.color.border}`;
                    verseElement.style.padding = '12px';
                    verseElement.style.margin = '8px 0';
                    verseElement.style.borderRadius = '6px';
                    verseElement.style.boxShadow = `0 2px 8px ${note.color.border}20`;
                } else {
                    verseElement.style.background = '';
                    verseElement.style.borderLeft = '';
                    verseElement.style.padding = '';
                    verseElement.style.margin = '';
                    verseElement.style.borderRadius = '';
                    verseElement.style.boxShadow = '';
                }
            });
        }
        
        // === SISTEMA DE TEMAS PERSONALIZABLES ===
        
        class ThemeManager {
            constructor() {
                this.storageKey = 'bible-theme-settings';
                this.settings = this.loadSettings();
                this.themes = {
                    light: {
                        name: 'Claro',
                        background: '#ffffff',
                        surface: '#f8f9fa',
                        primary: '#4285f4',
                        text: '#333333',
                        textSecondary: '#666666',
                        border: '#e0e0e0',
                        shadow: 'rgba(0,0,0,0.1)'
                    },
                    dark: {
                        name: 'Oscuro',
                        background: '#121212',
                        surface: '#1e1e1e',
                        primary: '#bb86fc',
                        text: '#ffffff',
                        textSecondary: '#b0b0b0',
                        border: '#333333',
                        shadow: 'rgba(255,255,255,0.1)'
                    },
                    sepia: {
                        name: 'Sepia',
                        background: '#f4f1e8',
                        surface: '#ede6d3',
                        primary: '#8b4513',
                        text: '#3d2914',
                        textSecondary: '#6b4423',
                        border: '#d4c4a8',
                        shadow: 'rgba(139,69,19,0.1)'
                    },
                    blue: {
                        name: 'Azul Noche',
                        background: '#0f1419',
                        surface: '#1a242f',
                        primary: '#64b5f6',
                        text: '#e1f5fe',
                        textSecondary: '#b3e5fc',
                        border: '#2d3748',
                        shadow: 'rgba(100,181,246,0.1)'
                    },
                    forest: {
                        name: 'Bosque',
                        background: '#1b2b1b',
                        surface: '#2d3a2d',
                        primary: '#81c784',
                        text: '#e8f5e8',
                        textSecondary: '#c8e6c9',
                        border: '#4a5d4a',
                        shadow: 'rgba(129,199,132,0.1)'
                    }
                };
                
                this.applyTheme();
                this.updateSystemMetaColor();
            }
            
            loadSettings() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : {
                        theme: 'light',
                        fontSize: 18,
                        lineHeight: 1.6,
                        fontFamily: 'system',
                        textAlign: 'left',
                        maxWidth: '800px',
                        padding: '20px'
                    };
                } catch (error) {
                    console.error('Error loading theme settings:', error);
                    return this.getDefaultSettings();
                }
            }
            
            getDefaultSettings() {
                return {
                    theme: 'light',
                    fontSize: 18,
                    lineHeight: 1.6,
                    fontFamily: 'system',
                    textAlign: 'left',
                    maxWidth: '800px',
                    padding: '20px'
                };
            }
            
            saveSettings() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.settings));
                    return true;
                } catch (error) {
                    console.error('Error saving theme settings:', error);
                    return false;
                }
            }
            
            updateSetting(key, value) {
                this.settings[key] = value;
                this.saveSettings();
                this.applyTheme();
                
                if (key === 'theme') {
                    this.updateSystemMetaColor();
                }
            }
            
            applyTheme() {
                const theme = this.themes[this.settings.theme];
                const root = document.documentElement;
                
                // Variables CSS para el tema
                root.style.setProperty('--bg-color', theme.background);
                root.style.setProperty('--surface-color', theme.surface);
                root.style.setProperty('--primary-color', theme.primary);
                root.style.setProperty('--text-color', theme.text);
                root.style.setProperty('--text-secondary', theme.textSecondary);
                root.style.setProperty('--border-color', theme.border);
                root.style.setProperty('--shadow-color', theme.shadow);
                
                // Configuraciones de texto
                root.style.setProperty('--font-size', `${this.settings.fontSize}px`);
                root.style.setProperty('--line-height', this.settings.lineHeight);
                root.style.setProperty('--text-align', this.settings.textAlign);
                root.style.setProperty('--max-width', this.settings.maxWidth);
                root.style.setProperty('--content-padding', this.settings.padding);
                
                // Font family
                const fontFamilies = {
                    system: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                    serif: 'Georgia, "Times New Roman", Times, serif',
                    mono: 'Menlo, Monaco, "Courier New", monospace'
                };
                root.style.setProperty('--font-family', fontFamilies[this.settings.fontFamily]);
                
                // Aplicar al body
                document.body.style.background = theme.background;
                document.body.style.color = theme.text;
                document.body.style.fontFamily = fontFamilies[this.settings.fontFamily];
                document.body.style.fontSize = `${this.settings.fontSize}px`;
                document.body.style.lineHeight = this.settings.lineHeight;
                
                // Aplicar estilos a elementos espec√≠ficos
                this.updateElementStyles(theme);
            }
            
            updateElementStyles(theme) {
                // Header
                const header = document.querySelector('header');
                if (header) {
                    header.style.background = theme.surface;
                    header.style.borderBottom = `1px solid ${theme.border}`;
                    header.style.boxShadow = `0 2px 10px ${theme.shadow}`;
                }
                
                // Containers
                const containers = document.querySelectorAll('.container, .content');
                containers.forEach(container => {
                    container.style.maxWidth = this.settings.maxWidth;
                    container.style.padding = this.settings.padding;
                });
                
                // Verses
                const verses = document.querySelectorAll('.verse');
                verses.forEach(verse => {
                    verse.style.color = theme.text;
                    verse.style.textAlign = this.settings.textAlign;
                });
                
                // Buttons
                const buttons = document.querySelectorAll('button:not(.favorite-btn):not(.note-btn)');
                buttons.forEach(button => {
                    if (!button.style.background || button.style.background === 'none') {
                        button.style.background = theme.surface;
                        button.style.color = theme.text;
                        button.style.border = `1px solid ${theme.border}`;
                    }
                });
                
                // Selects
                const selects = document.querySelectorAll('select');
                selects.forEach(select => {
                    select.style.background = theme.surface;
                    select.style.color = theme.text;
                    select.style.border = `1px solid ${theme.border}`;
                });
                
                // Update any existing highlights to match theme
                setTimeout(() => {
                    if (typeof updateVerseHighlights === 'function') {
                        updateVerseHighlights();
                    }
                }, 100);
            }
            
            updateSystemMetaColor() {
                const theme = this.themes[this.settings.theme];
                
                // Update meta theme-color for mobile browsers
                let metaThemeColor = document.querySelector('meta[name="theme-color"]');
                if (!metaThemeColor) {
                    metaThemeColor = document.createElement('meta');
                    metaThemeColor.name = 'theme-color';
                    document.head.appendChild(metaThemeColor);
                }
                metaThemeColor.content = theme.surface;
                
                // Update apple-mobile-web-app-status-bar-style
                let metaStatusBar = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
                if (!metaStatusBar) {
                    metaStatusBar = document.createElement('meta');
                    metaStatusBar.name = 'apple-mobile-web-app-status-bar-style';
                    document.head.appendChild(metaStatusBar);
                }
                metaStatusBar.content = this.settings.theme === 'dark' ? 'black-translucent' : 'default';
            }
            
            getCurrentTheme() {
                return this.themes[this.settings.theme];
            }
            
            getThemesList() {
                return Object.entries(this.themes).map(([key, theme]) => ({
                    id: key,
                    name: theme.name,
                    current: key === this.settings.theme
                }));
            }
            
            exportSettings() {
                const exportData = {
                    exportDate: new Date().toISOString(),
                    settings: this.settings,
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `biblia-tema-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }
        }
        
        // Inicializar manager de temas
        const themeManager = new ThemeManager();
        
        // Funci√≥n para abrir configuraci√≥n de temas
        function openThemeSettings() {
            showThemeModal();
        }
        
        function showThemeModal() {
            let modal = document.getElementById('themeModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'themeModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    z-index: 1003;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                document.body.appendChild(modal);
            }
            
            const themes = themeManager.getThemesList();
            const settings = themeManager.settings;
            
            const themeOptions = themes.map(theme => {
                const themeObj = themeManager.themes[theme.id];
                return `
                    <label style="display: block; padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid ${theme.current ? themeObj.primary : 'transparent'}; background: ${theme.current ? themeObj.surface : 'transparent'};" 
                           onmouseover="this.style.background='${themeObj.surface}'" 
                           onmouseout="this.style.background='${theme.current ? themeObj.surface : 'transparent'}'">
                        <input type="radio" name="themeSelect" value="${theme.id}" ${theme.current ? 'checked' : ''} 
                               style="margin-right: 8px;" onchange="changeTheme('${theme.id}')">
                        <div style="display: inline-flex; align-items: center; gap: 12px;">
                            <div style="display: flex; gap: 4px;">
                                <div style="width: 16px; height: 16px; background: ${themeObj.background}; border: 1px solid ${themeObj.border}; border-radius: 50%;"></div>
                                <div style="width: 16px; height: 16px; background: ${themeObj.surface}; border: 1px solid ${themeObj.border}; border-radius: 50%;"></div>
                                <div style="width: 16px; height: 16px; background: ${themeObj.primary}; border: 1px solid ${themeObj.border}; border-radius: 50%;"></div>
                            </div>
                            <span style="font-weight: ${theme.current ? 'bold' : 'normal'}; color: var(--text-color);">${theme.name}</span>
                        </div>
                    </label>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: var(--bg-color); border-radius: 12px; max-width: 90%; max-height: 85%; min-width: 400px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3); border: 1px solid var(--border-color);">
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, var(--primary-color), var(--primary-color)aa); color: white;">
                        <h2 style="margin: 0; font-size: 22px;">üé® Temas y Configuraci√≥n</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">Personaliza la apariencia de la aplicaci√≥n</p>
                    </div>
                    
                    <div style="padding: 25px; max-height: 70vh; overflow-y: auto;">
                        
                        <!-- Temas -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: var(--text-color); font-size: 18px;">üåà Temas</h3>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                ${themeOptions}
                            </div>
                        </div>
                        
                        <!-- Tipograf√≠a -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: var(--text-color); font-size: 18px;">üî§ Tipograf√≠a</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: var(--text-color);">Tama√±o de fuente:</label>
                                <input type="range" id="fontSizeSlider" min="14" max="24" value="${settings.fontSize}" 
                                       style="width: 100%; margin-bottom: 5px;" oninput="updateFontSize(this.value)">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 12px;">
                                    <span id="fontSizeDisplay">${settings.fontSize}px</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: var(--text-color);">Espaciado de l√≠nea:</label>
                                <input type="range" id="lineHeightSlider" min="1.2" max="2.0" step="0.1" value="${settings.lineHeight}" 
                                       style="width: 100%; margin-bottom: 5px;" oninput="updateLineHeight(this.value)">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 12px;">
                                    <span id="lineHeightDisplay">${settings.lineHeight}</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: var(--text-color);">Familia de fuente:</label>
                                <select id="fontFamilySelect" onchange="updateFontFamily(this.value)" 
                                        style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-color);">
                                    <option value="system" ${settings.fontFamily === 'system' ? 'selected' : ''}>Sistema</option>
                                    <option value="serif" ${settings.fontFamily === 'serif' ? 'selected' : ''}>Serif (Georgia)</option>
                                    <option value="mono" ${settings.fontFamily === 'mono' ? 'selected' : ''}>Monospace</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Layout -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: var(--text-color); font-size: 18px;">üìê Dise√±o</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: var(--text-color);">Alineaci√≥n del texto:</label>
                                <select id="textAlignSelect" onchange="updateTextAlign(this.value)" 
                                        style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-color);">
                                    <option value="left" ${settings.textAlign === 'left' ? 'selected' : ''}>Izquierda</option>
                                    <option value="center" ${settings.textAlign === 'center' ? 'selected' : ''}>Centrado</option>
                                    <option value="justify" ${settings.textAlign === 'justify' ? 'selected' : ''}>Justificado</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 8px; color: var(--text-color);">Ancho m√°ximo del contenido:</label>
                                <select id="maxWidthSelect" onchange="updateMaxWidth(this.value)" 
                                        style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-color);">
                                    <option value="600px" ${settings.maxWidth === '600px' ? 'selected' : ''}>Estrecho (600px)</option>
                                    <option value="800px" ${settings.maxWidth === '800px' ? 'selected' : ''}>Normal (800px)</option>
                                    <option value="1000px" ${settings.maxWidth === '1000px' ? 'selected' : ''}>Ancho (1000px)</option>
                                    <option value="100%" ${settings.maxWidth === '100%' ? 'selected' : ''}>Completo</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Vista previa -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; color: var(--text-color); font-size: 18px;">üëÅÔ∏è Vista previa</h3>
                            <div id="themePreview" style="padding: 15px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--surface-color); color: var(--text-color); font-family: var(--font-family); font-size: var(--font-size); line-height: var(--line-height); text-align: var(--text-align);">
                                <div style="margin-bottom: 8px;"><span style="font-weight: bold; color: var(--primary-color);">Juan 3:16</span></div>
                                <div>Porque de tal manera am√≥ Dios al mundo, que ha dado a su Hijo unig√©nito, para que todo aquel que en √©l cree, no se pierda, mas tenga vida eterna.</div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div style="padding: 20px; background: var(--surface-color); border-top: 1px solid var(--border-color); display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="resetThemeSettings()" 
                                style="background: var(--text-secondary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üîÑ Resetear
                        </button>
                        <button onclick="exportThemeSettings()" 
                                style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üì§ Exportar
                        </button>
                        <button onclick="closeThemeModal()" 
                                style="background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ‚úÖ Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function closeThemeModal() {
            const modal = document.getElementById('themeModal');
            if (modal) modal.style.display = 'none';
        }
        
        function changeTheme(themeId) {
            themeManager.updateSetting('theme', themeId);
            updateThemePreview();
            showToast(`üé® Tema cambiado a ${themeManager.themes[themeId].name}`, 'success');
        }
        
        function updateFontSize(size) {
            themeManager.updateSetting('fontSize', parseInt(size));
            document.getElementById('fontSizeDisplay').textContent = `${size}px`;
            updateThemePreview();
        }
        
        function updateLineHeight(height) {
            themeManager.updateSetting('lineHeight', parseFloat(height));
            document.getElementById('lineHeightDisplay').textContent = height;
            updateThemePreview();
        }
        
        function updateFontFamily(family) {
            themeManager.updateSetting('fontFamily', family);
            updateThemePreview();
        }
        
        function updateTextAlign(align) {
            themeManager.updateSetting('textAlign', align);
            updateThemePreview();
        }
        
        function updateMaxWidth(width) {
            themeManager.updateSetting('maxWidth', width);
            updateThemePreview();
        }
        
        function updateThemePreview() {
            const preview = document.getElementById('themePreview');
            if (preview) {
                preview.style.fontFamily = 'var(--font-family)';
                preview.style.fontSize = 'var(--font-size)';
                preview.style.lineHeight = 'var(--line-height)';
                preview.style.textAlign = 'var(--text-align)';
                preview.style.background = 'var(--surface-color)';
                preview.style.color = 'var(--text-color)';
                preview.style.border = '2px solid var(--border-color)';
            }
        }
        
        function resetThemeSettings() {
            if (confirm('¬øEst√°s seguro de que quieres resetear todos los ajustes de tema?')) {
                themeManager.settings = themeManager.getDefaultSettings();
                themeManager.saveSettings();
                themeManager.applyTheme();
                showToast('üîÑ Configuraci√≥n reseteada', 'info');
                closeThemeModal();
                setTimeout(() => openThemeSettings(), 300);
            }
        }
        
        function exportThemeSettings() {
            themeManager.exportSettings();
            showToast('üì§ Configuraci√≥n de tema exportada', 'success');
        }
        
        // === FUNCI√ìN SIMPLE Y DIRECTA PARA FAVORITOS ===
        function showFavorites() {
            console.log('üîñ Abriendo favoritos...');
            
            try {
                // Cargar favoritos del localStorage
                const favoritesData = localStorage.getItem('bible-favorites');
                let favorites = favoritesData ? JSON.parse(favoritesData) : [];
                
                console.log('Favoritos encontrados:', favorites.length);
                
                // Crear modal simple
                let modal = document.getElementById('simpleFavoritesModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'simpleFavoritesModal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.6);
                        z-index: 1005;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    document.body.appendChild(modal);
                }
                
                if (favorites.length === 0) {
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 80%; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
                            <div style="padding: 25px; text-align: center; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white;">
                                <h2 style="margin: 0; font-size: 24px;">‚≠ê Mis Favoritos</h2>
                                <p style="margin: 8px 0 0 0; opacity: 0.9;">Tu colecci√≥n personal de vers√≠culos</p>
                            </div>
                            <div style="padding: 40px; text-align: center;">
                                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üìñ</div>
                                <h3 style="color: #666; margin-bottom: 15px;">No tienes favoritos a√∫n</h3>
                                <p style="color: #888; margin-bottom: 25px; line-height: 1.6;">
                                    üí° Para agregar vers√≠culos a favoritos:<br>
                                    1. Navega a cualquier vers√≠culo<br>
                                    2. Busca la estrella ‚≠ê junto al n√∫mero del vers√≠culo<br>
                                    3. Haz clic en ella<br>
                                    4. ¬°Tu vers√≠culo se guardar√° aqu√≠!
                                </p>
                                <button onclick="closeFavorites()" style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                    Entendido
                                </button>
                                <br><br>
                                <p style="color: #999; font-size: 14px;">
                                    üìç Los favoritos se guardan autom√°ticamente en tu dispositivo
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    const favoritesHtml = favorites.map((fav, index) => `
                        <div style="padding: 16px; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background 0.2s;" 
                             onclick="navigateToFavorite('${fav.book}', ${fav.chapter}, ${fav.verse})"
                             onmouseover="this.style.background='#f8f9fa'" 
                             onmouseout="this.style.background='white'">
                            
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <strong style="color: #1976d2; font-size: 16px;">
                                        ${fav.reference || `${fav.book} ${fav.chapter}:${fav.verse}`}
                                    </strong>
                                    <div style="background: linear-gradient(135deg, #4285f4, #34a853); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; display: inline-block; margin-left: 8px;">
                                        ${fav.version || 'Versi√≥n'}
                                    </div>
                                </div>
                                
                                <button onclick="event.stopPropagation(); removeFavoriteSimple(${index})" 
                                        style="background: #ff4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; min-width: 60px;"
                                        onmouseover="this.style.background='#cc0000'"
                                        onmouseout="this.style.background='#ff4444'">
                                    üóëÔ∏è Quitar
                                </button>
                            </div>
                            
                            <div style="color: #666; font-size: 12px; margin-bottom: 8px;">
                                üìÖ Agregado: ${fav.dateAdded ? new Date(fav.dateAdded).toLocaleDateString('es-ES', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) : 'Fecha no disponible'}
                            </div>
                            
                            <div style="line-height: 1.6; color: #333; font-style: italic;">
                                "${(fav.text || 'Texto del vers√≠culo').substring(0, 200)}${fav.text && fav.text.length > 200 ? '...' : ''}"
                            </div>
                        </div>
                    `).join('');
                    
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 85%; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
                            
                            <div style="padding: 20px; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h2 style="margin: 0; font-size: 22px;">‚≠ê Mis Favoritos</h2>
                                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                            ${favorites.length} vers√≠culo${favorites.length !== 1 ? 's' : ''} guardado${favorites.length !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="exportFavoritesSimple()" 
                                                style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                            üì§ Exportar
                                        </button>
                                        <button onclick="closeFavorites()" 
                                                style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 18px; width: 36px; height: 36px;">
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="max-height: 65vh; overflow-y: auto;">
                                ${favoritesHtml}
                            </div>
                            
                            <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #e0e0e0; text-align: center;">
                                <div style="color: #666; font-size: 13px; margin-bottom: 5px;">
                                    üí° Haz clic en cualquier referencia para ir al vers√≠culo
                                </div>
                                <div style="color: #888; font-size: 12px;">
                                    Los favoritos se guardan autom√°ticamente en tu dispositivo
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error al mostrar favoritos:', error);
                alert('‚ùå Error al cargar favoritos. Revisa la consola para m√°s detalles.');
            }
        }
        
        function closeFavorites() {
            const modal = document.getElementById('simpleFavoritesModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function removeFavoriteSimple(index) {
            if (confirm('¬øEst√°s seguro de que quieres quitar este vers√≠culo de favoritos?')) {
                try {
                    const favoritesData = localStorage.getItem('bible-favorites');
                    let favorites = favoritesData ? JSON.parse(favoritesData) : [];
                    
                    if (index >= 0 && index < favorites.length) {
                        favorites.splice(index, 1);
                        localStorage.setItem('bible-favorites', JSON.stringify(favorites));
                        showToast('üóëÔ∏è Vers√≠culo quitado de favoritos', 'info');
                        showFavorites(); // Refrescar la lista
                    }
                } catch (error) {
                    console.error('Error al quitar favorito:', error);
                    alert('‚ùå Error al quitar el favorito.');
                }
            }
        }
        
        function exportFavoritesSimple() {
            try {
                const favoritesData = localStorage.getItem('bible-favorites');
                const favorites = favoritesData ? JSON.parse(favoritesData) : [];
                
                const exportData = {
                    exportDate: new Date().toISOString(),
                    totalFavorites: favorites.length,
                    favorites: favorites
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `biblia-favoritos-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showToast('üì§ Favoritos exportados exitosamente', 'success');
            } catch (error) {
                console.error('Error al exportar favoritos:', error);
                alert('‚ùå Error al exportar favoritos.');
            }
        }
        
        function navigateToFavorite(book, chapter, verse) {
            console.log(`Navegando a: ${book} ${chapter}:${verse}`);
            closeFavorites();
            
            if (window.bibleApp) {
                window.bibleApp.selectBook(book).then(() => {
                    setTimeout(() => {
                        window.bibleApp.loadChapter(book, parseInt(chapter)).then(() => {
                            setTimeout(() => {
                                const verseElement = document.querySelector(`[data-verse="${verse}"]`);
                                if (verseElement) {
                                    verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    
                                    // Resaltar vers√≠culo
                                    verseElement.style.background = 'linear-gradient(135deg, #ff6b35, #f7931e)';
                                    verseElement.style.color = 'white';
                                    verseElement.style.padding = '12px';
                                    verseElement.style.borderRadius = '8px';
                                    verseElement.style.transform = 'scale(1.02)';
                                    verseElement.style.transition = 'all 0.3s ease';
                                    verseElement.style.boxShadow = '0 4px 15px rgba(255, 107, 53, 0.3)';
                                    
                                    setTimeout(() => {
                                        verseElement.style.background = '';
                                        verseElement.style.color = '';
                                        verseElement.style.padding = '';
                                        verseElement.style.transform = '';
                                        verseElement.style.boxShadow = '';
                                    }, 4000);
                                }
                            }, 500);
                        });
                    }, 200);
                });
            } else {
                alert('üìç App no disponible. Recarga la p√°gina y selecciona una versi√≥n b√≠blica primero.');
            }
        }
    </script>
    
    <script src="js/app.js"></script>
    <script src="js/features-level1.js"></script>
    <script src="js/bible-data.js"></script>
    <script src="js/bible-converter.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/biblia-json/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html><-/Library/Preferences/VisualStudio Cache buster: Thu Nov  6 17:41:27 PST 2025 -->
