<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Biblia Digital - M√∫ltiples Versiones</title>
    <!-- Actualizado: 2025-11-06 - Fix para cambio de versiones -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <h1>üìñ Biblia Digital</h1>
            <div class="header-controls">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Busca desde 3 letras... (ej: jesus)" class="search-input">
                    <button id="searchBtn" class="icon-btn" title="Buscar" onclick="simpleSearch()">üîç</button>
                </div>
                <select id="versionSelector" class="version-selector">
                    <option value="">Seleccionar versi√≥n...</option>
                </select>
                <button id="favoritesBtn" class="icon-btn" title="Favoritos" onclick="openSimpleFavorites()">üîñ</button>
                <button id="compareBtn" class="icon-btn" title="Comparar versiones">üîÑ</button>
                <button id="settingsBtn" class="icon-btn" title="Configuraci√≥n">‚öôÔ∏è</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="book-navigation">
        <div class="nav-content">
            <select id="bookSelector" class="book-selector">
                <option value="">Seleccionar libro...</option>
            </select>
            <select id="chapterSelector" class="chapter-selector">
                <option value="">Cap...</option>
            </select>
            <div class="nav-buttons">
                <button id="prevChapter" class="nav-btn" title="Cap√≠tulo anterior">‚óÄ</button>
                <button id="nextChapter" class="nav-btn" title="Cap√≠tulo siguiente">‚ñ∂</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="reading-area">
            <div id="chapterTitle" class="chapter-title"></div>
            <div id="verseContainer" class="verse-container">
                <div class="welcome-message">
                    <h2>Bienvenido a la Biblia Digital</h2>
                    <p>Selecciona una versi√≥n y un libro para comenzar a leer.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner hidden">
        <div class="spinner"></div>
        <p>Cargando...</p>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuraci√≥n</h3>
                <button id="closeSettings" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label for="fontSize">Tama√±o de fuente:</label>
                    <input type="range" id="fontSize" min="14" max="24" value="16">
                    <span id="fontSizeValue">16px</span>
                </div>
                <div class="setting-group">
                    <label for="lineHeight">Altura de l√≠nea:</label>
                    <input type="range" id="lineHeight" min="1.2" max="2.0" step="0.1" value="1.6">
                    <span id="lineHeightValue">1.6</span>
                </div>
                <div class="setting-group">
                    <label for="theme">Tema:</label>
                    <select id="theme">
                        <option value="light">Claro</option>
                        <option value="dark">Oscuro</option>
                        <option value="sepia">Sepia</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="showVerseNumbers"> Mostrar n√∫meros de vers√≠culos
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Versions Modal -->
    <div id="compareModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Comparar Versiones</h3>
                <button id="closeCompare" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="compare-controls">
                    <select id="compareVersion1">
                        <option value="">Selecciona versi√≥n 1</option>
                    </select>
                    <select id="compareVersion2">
                        <option value="">Selecciona versi√≥n 2</option>
                    </select>
                </div>
                <div id="comparisonContent" class="comparison-content">
                    <p>Selecciona dos versiones para comparar</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results Modal -->
    <div id="searchModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Resultados de B√∫squeda</h3>
                <button id="closeSearch" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="search-info">
                    <span id="searchQuery"></span> - <span id="searchCount">0 resultados</span>
                </div>
                <div id="searchResults" class="search-results">
                    <p>Introduce un t√©rmino de b√∫squeda</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favoritesModal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Vers√≠culos Favoritos</h3>
                <button id="closeFavorites" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="favorites-controls">
                    <select id="categoryFilter" class="category-filter">
                        <option value="all">Todas las categor√≠as</option>
                        <option value="oraci√≥n">Oraci√≥n</option>
                        <option value="estudio">Estudio</option>
                        <option value="predicaci√≥n">Predicaci√≥n</option>
                        <option value="consuelo">Consuelo</option>
                        <option value="sabidur√≠a">Sabidur√≠a</option>
                    </select>
                    <button id="exportFavorites" class="btn-secondary">üì§ Exportar</button>
                </div>
                <div id="favoritesList" class="favorites-list">
                    <p>No tienes vers√≠culos favoritos a√∫n. ‚ù§Ô∏è Haz clic en el coraz√≥n junto a un vers√≠culo para agregarlo.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuraci√≥n</h3>
                <button id="closeSettings" class="close-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <h4>üé® Apariencia</h4>
                    <div class="setting-item">
                        <label for="themeSelect">Tema:</label>
                        <select id="themeSelect" class="theme-select">
                            <option value="light">üåû Claro</option>
                            <option value="dark">üåô Oscuro</option>
                            <option value="sepia">üìú Sepia</option>
                            <option value="blue">üåä Azul</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="fontSizeRange">Tama√±o de fuente:</label>
                        <input type="range" id="fontSizeRange" min="12" max="24" value="16" class="font-range">
                        <span id="fontSizeValue">16px</span>
                    </div>
                </div>
                <div class="setting-group">
                    <h4>üìñ Lectura</h4>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="showVerseNumbers"> Mostrar n√∫meros de vers√≠culos
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="highlightEnabled"> Habilitar resaltado
                        </label>
                    </div>
                </div>
                <div class="setting-group">
                    <h4>üìä Datos</h4>
                    <div class="setting-item">
                        <button id="clearCache" class="btn-secondary">üóëÔ∏è Limpiar cach√©</button>
                        <button id="exportData" class="btn-secondary">üíæ Exportar datos</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="connectionStatus" class="status-offline">üì° Offline</span>
        <span id="lastUpdate"></span>
    </div>

    <script>
        // Funci√≥n para normalizar texto (quitar acentos, convertir a min√∫sculas)
        function normalizeText(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remover acentos
                .replace(/[^a-z0-9\s]/g, ' ')    // Remover caracteres especiales
                .replace(/\s+/g, ' ')            // Normalizar espacios
                .trim();
        }
        
        // Variable para debounce de b√∫squeda en tiempo real
        let searchTimeout;
        
        // Funci√≥n de b√∫squeda mejorada
        function smartSearch(query = null) {
            console.log('=== SMART SEARCH STARTED ===');
            
            const searchInput = document.getElementById('searchInput');
            let searchQuery = query || searchInput.value.trim();
            
            console.log('Original query:', searchQuery);
            
            if (searchQuery.length < 3) {
                closeSimpleSearch();
                return;
            }
            
            // Verificar si hay una app cargada
            if (!window.bibleApp || !window.bibleApp.bibleData) {
                if (searchQuery.length >= 3) {
                    alert('Por favor, selecciona y carga una versi√≥n de la Biblia primero.');
                }
                return;
            }
            
            const bibleData = window.bibleApp.bibleData;
            console.log('Bible data available:', !!bibleData);
            
            // Normalizar la consulta de b√∫squeda
            const normalizedQuery = normalizeText(searchQuery);
            console.log('Normalized query:', normalizedQuery);
            
            const results = [];
            let searchCount = 0;
            const maxResults = 100; // Aumentamos a 100 resultados
            
            // Buscar en todos los libros
            Object.keys(bibleData).forEach(bookName => {
                if (searchCount >= maxResults) return;
                
                Object.keys(bibleData[bookName]).forEach(chapterNum => {
                    if (searchCount >= maxResults) return;
                    
                    Object.keys(bibleData[bookName][chapterNum]).forEach(verseNum => {
                        if (searchCount >= maxResults) return;
                        
                        const originalText = bibleData[bookName][chapterNum][verseNum];
                        const normalizedText = normalizeText(originalText);
                        
                        // Buscar tanto con query original como normalizada
                        if (normalizedText.includes(normalizedQuery) || 
                            originalText.toLowerCase().includes(searchQuery.toLowerCase())) {
                            
                            results.push({
                                book: bookName,
                                chapter: chapterNum,
                                verse: verseNum,
                                text: originalText,
                                reference: `${bookName} ${chapterNum}:${verseNum}`,
                                normalizedText: normalizedText
                            });
                            searchCount++;
                        }
                    });
                });
            });
            
            console.log('Results found:', results.length);
            
            // Mostrar resultados inmediatamente
            showSmartSearchResults(searchQuery, normalizedQuery, results);
        }
        
        // Funci√≥n de b√∫squeda en tiempo real con debounce
        function realTimeSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                smartSearch();
            }, 300); // Esperar 300ms despu√©s de dejar de escribir
        }
        
        function showSmartSearchResults(originalQuery, normalizedQuery, results) {
            console.log('Showing smart search results...');
            
            // Crear modal din√°micamente si no existe
            let modal = document.getElementById('simpleSearchModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'simpleSearchModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                document.body.appendChild(modal);
            }
            
            if (results.length === 0) {
                modal.innerHTML = `
                    <div style="background: white; border-radius: 8px; max-width: 80%; max-height: 80%; overflow-y: auto; position: relative; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>No se encontraron resultados para "${originalQuery}"</h3>
                            <button onclick="closeSimpleSearch()" style="background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
                        </div>
                        <p style="color: #666;">Intenta con otras palabras o verifica la ortograf√≠a.</p>
                        <p style="color: #888; font-size: 14px;">üí° Tip: La b√∫squeda funciona sin acentos (Jesus = Jes√∫s)</p>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }
            
            // Crear expresiones regulares para resaltar tanto query original como normalizada
            const highlightRegex1 = new RegExp(`(${escapeRegExp(originalQuery)})`, 'gi');
            const highlightRegex2 = new RegExp(`(${escapeRegExp(normalizedQuery)})`, 'gi');
            
            const resultsHtml = results.map((result, index) => {
                let highlightedText = result.text;
                
                // Resaltar coincidencias (primero query original, luego normalizada)
                highlightedText = highlightedText.replace(highlightRegex1, '<mark style="background: #ffeb3b; padding: 1px 3px; border-radius: 2px; font-weight: bold;">$1</mark>');
                
                // Si no hay coincidencias con query original, intentar con normalizada
                if (!highlightedText.includes('<mark')) {
                    // Buscar palabras que coincidan despu√©s de normalizar
                    const words = result.text.split(/\s+/);
                    words.forEach(word => {
                        const normalizedWord = normalizeText(word);
                        if (normalizedWord.includes(normalizedQuery)) {
                            const wordRegex = new RegExp(`\\b${escapeRegExp(word)}\\b`, 'gi');
                            highlightedText = highlightedText.replace(wordRegex, '<mark style="background: #81c784; padding: 1px 3px; border-radius: 2px; font-weight: bold;">$&</mark>');
                        }
                    });
                }
                
                return `
                    <div style="padding: 16px; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background 0.2s;" 
                         onclick="goToVerse('${result.book}', ${result.chapter}, ${result.verse})"
                         onmouseover="this.style.background='#f5f5f5'" 
                         onmouseout="this.style.background='white'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #1976d2; font-size: 16px;">${result.reference}</strong>
                            <span style="color: #666; font-size: 12px;">#${index + 1}</span>
                        </div>
                        <div style="line-height: 1.6; color: #333;">${highlightedText}</div>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 85%; max-height: 85%; overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="padding: 20px; border-bottom: 2px solid #e0e0e0; background: linear-gradient(135deg, #1976d2, #42a5f5); color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 20px;">üîç Resultados de b√∫squeda</h3>
                                <p style="margin: 5px 0 0 0; opacity: 0.9;">"${originalQuery}" - ${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}</p>
                            </div>
                            <button onclick="closeSimpleSearch()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 18px; width: 40px; height: 40px;">‚úï</button>
                        </div>
                    </div>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        ${resultsHtml}
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #e0e0e0; text-align: center; color: #666; font-size: 14px;">
                        üí° Haz clic en cualquier resultado para ir al vers√≠culo
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // Funci√≥n para escapar caracteres especiales en regex
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Funci√≥n simple de b√∫squeda (mantener compatibilidad)
        function simpleSearch() {
            smartSearch();
        }
        
        function closeSimpleSearch() {
            const modal = document.getElementById('simpleSearchModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function goToVerse(book, chapter, verse) {
            console.log(`Navigating to ${book} ${chapter}:${verse}`);
            closeSimpleSearch();
            
            if (window.bibleApp) {
                // Navegar al vers√≠culo
                window.bibleApp.selectBook(book).then(() => {
                    setTimeout(() => {
                        window.bibleApp.loadChapter(book, parseInt(chapter)).then(() => {
                            setTimeout(() => {
                                const verseElement = document.querySelector(`[data-verse="${verse}"]`);
                                if (verseElement) {
                                    verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    verseElement.style.background = 'linear-gradient(135deg, #4285f4, #34a853)';
                                    verseElement.style.color = 'white';
                                    verseElement.style.padding = '12px';
                                    verseElement.style.borderRadius = '8px';
                                    verseElement.style.transform = 'scale(1.02)';
                                    verseElement.style.transition = 'all 0.3s ease';
                                    verseElement.style.boxShadow = '0 4px 15px rgba(66, 133, 244, 0.3)';
                                    
                                    setTimeout(() => {
                                        verseElement.style.background = '';
                                        verseElement.style.color = '';
                                        verseElement.style.padding = '';
                                        verseElement.style.transform = '';
                                        verseElement.style.boxShadow = '';
                                    }, 4000);
                                }
                            }, 500);
                        });
                    }, 200);
                });
            }
        }
        
        // Configurar b√∫squeda en tiempo real
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // B√∫squeda en tiempo real mientras escribes
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.trim();
                    if (query.length >= 3) {
                        realTimeSearch();
                    } else if (query.length === 0) {
                        closeSimpleSearch();
                    }
                });
                
                // Tambi√©n permitir b√∫squeda con Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        smartSearch();
                    }
                });
                
                // Mostrar tip cuando hace focus
                searchInput.addEventListener('focus', function() {
                    if (!this.value) {
                        this.placeholder = 'Escribe al menos 3 letras (ej: jesus, Jes√∫s, JES√öS...)';
                    }
                });
                
                searchInput.addEventListener('blur', function() {
                    this.placeholder = 'Buscar en la Biblia...';
                });
            }
        });
        
        // Funci√≥n simple para favoritos
        function openSimpleFavorites() {
            alert('üîñ Funci√≥n de favoritos en desarrollo.\n\n‚ú® Por ahora disfruta la b√∫squeda mejorada:\n‚Ä¢ Busca desde 3 letras\n‚Ä¢ Sin importar acentos\n‚Ä¢ Resultados en tiempo real');
        }
    </script>
    
    <script src="js/app.js"></script>
    <script src="js/features-level1.js"></script>
    <script src="js/bible-data.js"></script>
    <script src="js/bible-converter.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/biblia-json/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html><-/Library/Preferences/VisualStudio Cache buster: Thu Nov  6 17:41:27 PST 2025 -->
